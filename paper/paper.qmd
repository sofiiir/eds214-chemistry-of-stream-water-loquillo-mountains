---
title: "EDS-214 Reproducible Workflows: Hurricane Hugo Effects on Stream Chemistry"
format: html
execute:
  message: false
  warning: false
---

# Background

The course EDS-214 titled workflows and reproducibility, emphasizes a real world example of data analysis that benefits from workflow organization and reproducible code. This course has chosen Schaefer et al.'s (2000) study analyzing the effects of Hurricane Hugo on the watersheds of the Loquillo Mountain Watershed in Puerto Rico as a case stude. In this repository, figure 3 from Schaefer et al.'s (2000) paper was reproduced.

```{r}
#| warning: false
#| message: false
#| echo: false

#Environment initialization package installations for computers running this data set for the first time
#*****THE LINE BELOW MUST BE UNCOMMENTED TO INITIALIZE AN ENVIRONMENT
#source(here("R", "environment_initialization.R"))

#calling libraries
library(tidyverse)
library(here)
library(janitor)
library(patchwork)
library(zoo)
library(png)

#sourcing the moving average function for analysis of the data 
source(here("R", "moving-average-function.R"))
```

# Data

Data was downloaded from the [Environmental Data Initiative](https://portal.edirepository.org/nis/metadataviewer?packageid=knb-lter-luq.20.4923064), an open source environmental database.

doi:10.6073/pasta/f31349bebdc304f758718f4798d25458

```{r}
#| echo: false
#read in data
watershed_data <- read_csv(here::here("outputs", "compiled_data.csv"))
```

# Methods

Data was cleaned and wrangled to include only necessary metrics to complete the recreation of figure 3 from Schaffer et. al. The pre-analysis product was a single dataframe containing the values for all of the locations nutrient contents.

Once cleaned, the data was analysed to calculate 9-week moving averages. A moving average function was created for clarity and reproducibility. Below is an example of the code calling this function and calculating the values for the 9-week moving average for one of the five nutrients being graphed. This code was run for each of the nutrients.

```{r}
#|eval: false
#calculating 9 day moving average using mutate and group by 
mov_avg_k <- watershed_data |> 
  group_by(sample_id) |> #group by sample sites
  #mutating to create a new column
  mutate(mov_avg_k = sapply(sample_date, #sapply to run on all of the data 
                            moving_average, 
                            sample_date = sample_date, 
                            nutrient_conc = k, 
                            win_size_wks = 9)) |> 
  #selecting for just necessary data to create a plot 
  select(sample_id, sample_date, k, mov_avg_k)

```

```{r}
#| echo: false
#read in moving average data sets
mov_avg_k <- read_csv(here::here("outputs", "mov_avg_k.csv"))
mov_avg_no3_n <- read_csv(here::here("outputs", "mov_avg_no3_n.csv"))
mov_avg_mg <- read_csv(here::here("outputs", "mov_avg_mg.csv"))
mov_avg_ca <- read_csv(here::here("outputs", "mov_avg_ca.csv"))
mov_avg_nh4_n <- read_csv(here::here("outputs", "mov_avg_nh4_n.csv"))
```

# Results

Each dataframe for the individual nutrients was plotted and combined into a single graph. The graph below is as close a replica of the original graph from Schaefer et al. (2000) as possible given differences in data.

```{r}
#| echo: false
#| warning: false
#| message: false

#displaying figure
#fig3

#show graph in quarto doc
source(here::here("3.ggplotting.R"))
fig3

#ggsave(here::here("figs", "fig3.jpg"))

```

Figure 3. Concentrations of 9-week averages of potassium (k), nitrate-N, magnesium (mg), calcium (ca), and ammonium-N (Nh4-n) in four streams in the Loquillo Mountain Watershed before and after Hurricane Hugo. The vertical lines indicate Hurricane Hugo, the event of study.
